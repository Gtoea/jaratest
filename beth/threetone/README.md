- - - - - - - - - - - - - - - - - - - - -
# Defining parameters for names and subjects for study
## `studyparams.py`



- - - - - - - - - - - - - - - - - - - - -
# Producing a generic database
## `database_generation.py`
This script will generate a database with all clusters filtered by ISI and quality. The function that creates the database excludes clusters with ISI > 0.05 and spikeQuality < 2. You can run this script from an iPython terminal after clustering and it will create a complete database from the raw data and inforec for a given subject or set of subjects (subject(s) specified in studyparams.py). The database is then saved as a .h5 file to the local machine.

## Database contents
The initial database is generated by `celldatabase.generate_cell_database_from_subjects()`. It contains columns according to the inforec files (`'subject'`, `'date'`, etc) and the spike sorting results (`'cluster'`, `'spikeShape'`, etc). The columns produced by this database can be found in the documentation for celldatabase.

### Base stats:
These are additional columns calculated for all cells:

`Only ascending columns are documented here, but columns for both the ascending and descending sessions are computed in the script (descending denoted by a trailing 'D' rather than the trailing 'A' seen below).`
* *meanEvokedHighA*: mean firing rate of all high frequency trials in the ascending session for 100ms following event onset.
* *meanBaseHighA*: mean firing rate 100ms before all high frequency events in the ascending session.
* *pValHighResponseA*: p-value comparing the spike counts of the evoked and baseline ranges for the high frequency trials using the Mann-Whitney U test.

* *meanEvokedMidA*: mean firing rate of all middle frequency trials in the ascending session for 100ms following event onset.
* *meanBaseMidA*: mean firing rate 100ms before all middle frequency events in the ascending session.
* *pValMidResponseA*: p-value comparing the spike counts of the evoked and baseline ranges for the middle frequency trials using the Mann-Whitney U test.

* *meanEvokedLowA*: mean firing rate of all low frequency trials in the ascending session 100ms following event onset.
* *meanBaseLowA*: mean firing rate 100ms before all low frequency events in the ascending session.
* *pValLowResponseA*: p-value comparing the spike counts of the evoked and baseline ranges for the low frequency trials using the Mann-Whitney U test.

`In the ascending session, the high frequency tone corresponds to the first oddball, the middle frequency to the second oddball, etc. The full list is below:
  Ascending session: ['High', 'First']; ['Mid', 'Second']; ['Low', 'Third']
  Descending session: ['High', 'Third']; ['Mid', 'Second']; ['Low', 'First']`

* *meanEvokedFirstOddA*: mean firing rate of the high frequency sound when presented as an oddball for 100ms following event onset.
* *meanBaseFirstOddA*: mean firing rate 100ms before the high frequency sound is presented as an oddball.
* *meanEvokedFirstStdA*: mean firing rate of the high frequency sound presented immediately before the same high frequency sound presented as an oddball (standard) for 100ms following standard event onset.
* *meanBaseFirstStdA*: mean firing rate 100ms before the high frequency sound is presented as a standard.
* *pValHighFRA*: p-value comparing the spike counts of the evoked and baseline ranges for the high frequency oddball and standard trials using the Mann-Whitney U test.

* *meanEvokedSecondOddA*: mean firing rate of the middle frequency sound when presented as an oddball for 100ms following event onset.
* *meanBaseSecondOddA*: mean firing rate 100ms before the middle frequency sound is presented as an oddball.
* *meanEvokedSecondStdA*: mean firing rate of the middle frequency sound presented immediately before the same middle frequency sound presented as an oddball (standard) for 100ms following standard event onset.
* *meanBaseSecondStdA*: mean firing rate 100ms before the middle frequency sound is presented as a standard.
* *pValMidFRA*: p-value comparing the spike counts of the evoked and baseline ranges for the middle frequency oddball and standard trials using the Mann-Whitney U test.

* *meanEvokedThirdOddA*: mean firing rate of the low frequency sound when presented as an oddball for 100ms following event onset.
* *meanBaseThirdOddA*: mean firing rate 100ms before the low frequency sound is presented as an oddball.
* *meanEvokedThirdStdA*: mean firing rate of the low frequency sound presented immediately before the same low frequency sound presented as an oddball (standard) for 100ms following standard event onset.
* *meanBaseThirdStdA*: mean firing rate 100ms before the low frequency sound is presented as a standard.
* *pValLowFRA*: p-value comparing the spike counts of the evoked and baseline ranges for the low frequency oddball and standard trials using the Mann-Whitney U test.

### Indices:
These are additional columns calculated for a selected set of cells:

`Only ascending columns are documented here, but columns for both the ascending and descending sessions are computed in the script (descending denoted by a trailing 'D' rather than the trailing 'A' seen below).`

* *expIndHighA*: A-B/A+B where A is the mean firing rate during sound presentation of the high frequency oddball tone and B is the mean firing rate during sound presentation of the high frequency tone acting as the standard.
* *expIndMidA*: A-B/A+B where A is the mean firing rate during sound presentation of the middle frequency oddball tone and B is the mean firing rate during sound presentation of the middle frequency tone acting as the standard.
* *expIndLowA*: A-B/A+B where A is the mean firing rate during sound presentation of the low frequency oddball tone and B is the mean firing rate during sound presentation of the low frequency tone acting as the standard.



- - - - - - - - - - - - - - - - - - - - -
# Producing a database of responsive cells
## `database_generation_responsive_cells.py`
This script will generate a database of all responsive cells from the total list of cells found in `database_generation.py` based on a p-Value threshold, a firing rate threshold between evoked and baseline in the freq. sorted raster, and the ratio between the evoked and baseline firing rates. You can run this script from an iPython terminal after creating the generic database for a given subject or set of subjects (subject(s) specified in studyparams.py). The database is then saved as a .h5 file to the local machine.

A cell is considered responsive if:
1. The number of cell firings 100 ms before sound presentation is significantly different (set by the p-value threshold) than the number of cell firings during sound presentation for either of the frequencies in the three-tone sequence and for either of the sessions: ascending or descending.
2. The evoked firing rate of any of the six frequencies (three in each of the ascending and descending sequences) has a minimum firing rate (set by the firing rate threshold).
3. There exists a difference between the evoked and baseline firing rates (set by the ratio of firing rates). This takes into account cells that may be suppressed during sound presentation.



- - - - - - - - - - - - - - - - - - - - -
# Producing a database of significantly responsive cells
## `significant_cells.py`
This script will generate a database of all significantly responsive cells from the total list of responsive cells created in `database_generation_responsive_cells.py`. It counts how many of the responsive cells show a significant difference between expected and unexpected firing rates for their most responsive frequency. You can run this script from an iPython terminal after creating the generic database for a given subject or set of subjects (subject(s) specified in studyparams.py). The database is then saved as a .h5 file to the local machine.

## Database contents
Two columns are added to the responsivedb.
* *mostRespFreqPValueOddStdA*: The p-Value between evoked firing rates for the expected and unexpected tones corresponding to whichever frequency had the most significantly different evoked and baseline spike counts for the ascending sequence.  
* *mostRespFreqPValueOddStdD*: The p-Value between evoked firing rates for the expected and unexpected tones corresponding to whichever frequency had the most significantly different evoked and baseline spike counts for the ascending sequence.  

signRespCellsdb is the database created from the two new columns in responsivedb. If either of the p-Values comparing the evoked firing rates for the expected vs unexpected for the most responsive frequency is below the p_value threshold, the cell is considered significant and is added to the database.



- - - - - - - - - - - - - - - - - - - - -
# Producing a database of significantly responsive suppressed cells
## `suppressed_cells.py`
This script will generate a database of all significantly responsive suppressed cells from the total list of significantly responsive cells created in `significant_cells.py`. For the most responsive frequency, a list of the cells where the baseline firing rate is larger than the evoked firing rate is compiled. The list is then turned into a Pandas dataframe. You can run this script from an iPython terminal after creating the significantly responsive cell database for a given subject or set of subjects (subject(s) specified in studyparams.py). The database is then saved as a .h5 file to the local machine.

If a cell is added to the database due to suppression in the ascending session, it does not add the cell again if the baseline firing rate is larger than the evoked firing rate for the most responsive frequency in the descending sequence.



- - - - - - - - - - - - - - - - - - - - -
# Reports
## `report_generation.py`
This generates a report for each cell, showing white noise (noiseburst) cell response (raster) and waveform, tuning curve (raster), tuning curve ISI, and the ascending & descending paradigm response, including frequency-sorted rasters, rasters of first/second/third oddball and first/second/third standard responses, PSTHs comparing the first, second, & third oddballs to their standards, and the last descending waveform to verify cell drifting hasn't taken place. All reports require access to the database, the clustered ephys data, and the behavior data.

The reports are saved in a location specified in `settings.py` (FIGURES_DATA_PATH).



- - - - - - - - - - - - - - - - - - - - -
# Figures
## `expectedFR_unexpectedFR_figure_generation.py`
This script generates a graph comparing the first, second, and third oddball firing rates to their corresponding standard firing rates for the ascending sequence. If the graph is shifted towards the oddball firing rate side of the 45 degree line, there is a propensity for cells to fire more during the unexpected presentation of the sound. The graph of oddball evoked firing rate vs standard evoked firing rate for only the best frequency is plotted.


## `exp_index_hist_best_figure_generation.py`
This script generates a histogram from combined ascending and descending sessions' by taking the best expectation index ('best' meaning closest to 1) between the two sessions for a single frequency from the responsive cell database. The same is done for the set of cells that are significantly responsive. There is also the same histogram but separated by auditory cortical region.


## `exp_index_hist_figure_generation.py`
This script generates a series of expectation index histograms for a specified database (responsive cells or suppressed cells) separated by session (ascending and descending) and frequency (high, middle, low). We sort each of the responsive (suppressed) cells into one of three databases - one for each frequency - depending on which of the three frequencies the cell was most responsive to. The expectation index for the most responsive frequency of these cells are plotted in the histogram. In each of these databases, we find the number of cells which had a significant difference in firing between the oddball and standard for the most responsive frequency. The significant cells' expectation indices are shaded in the histograms.

For cells that were most responsive to the high frequency sound, for example, we find a subset of these cells which also show a significant difference in firing between the high frequency tone when presented unexpectedly vs expectedly. Thus, the total number of cells for all three frequencies in the histograms adds up to be the total number of cells in the responsive database. Since each cell can only have one best frequency, each cell is represented only once per session in the histograms.


## `exp_index_hist_by_region_figure_generation.py`
This script generates expectation index histograms for all frequencies in both sessions for either the responsive cells and significant responsive cells or suppression cells and significant suppression cells separated by auditory cortical region.
